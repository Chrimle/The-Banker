<!doctype html>
<html>

<head>
    <title>The Banker</title>
    <meta charset="utf-8">
    <meta name="copyright" content="© 2025 Chrimle. All rights reserved.">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="version" content="47">
    <link rel="stylesheet" href="main.css">
</head>

<body>
    <header>
        <div>
            <h1>The Banker</h1>
        </div>
        <div class="version-pill"></div>
        <p><em>Manage your own bank...</em></p>
        <button id="info-btn" title="How to play">
            <span class="info-icon">&#x2753;</span>
        </button>
    </header>
    <div id="table">
        <div class="drawer"></div>
        <div class="lid">
            <div class="handle"></div>
        </div>
    </div>
    <template id="bill-template">
        <div class="bill" data-value="" style="left:0; top:0;">
            <div class="inner">
                <div class="face front">
                    <div class="denom denom-topleft"></div>
                    <div class="denom denom-topright"></div>
                    <div class="bill-center">U$D</div>
                    <div class="denom denom-bottomright"></div>
                    <div class="denom denom-bottomleft"></div>
                </div>
                <div class="face back">United States Dollar</div>
            </div>
        </div>
    </template>
    <div id="howto-popup" class="howto-popup" hidden>
        <div class="howto-popup-content">
            <button class="howto-popup-close" title="Close">&times;</button>
            <h2>How to play</h2>
            <ul>
                <li><strong>Click & Hold</strong> - <em>to pick up a bill.</em></li>
                <li><strong>Double-click</strong> - <em>to flip a bill.</em></li>
                <li><strong>Mouse Wheel</strong> - <em>to rotate a bill.</em></li>
            </ul>
            <p>Have fun!</p>
        </div>
    </div>
    <script type="module">
        import { randomInt } from './scripts/maths.js';
        import { setupHowToPopup } from './scripts/how-to-popup.js';

        const versionMeta = document.querySelector('meta[name="version"]');
        const versionNumber = versionMeta ? versionMeta.content : "N/A";

        const pill = document.querySelector(".version-pill");
        pill.textContent = `v${versionNumber}`;

        function getDrawerEdges() {
            const drawerRect = document.querySelector('.drawer').getBoundingClientRect();
            return {
                left: drawerRect.left,
                right: drawerRect.right,
                top: drawerRect.top,
                bottom: drawerRect.bottom
            };
        }

        const table = document.getElementById('table');

        table.addEventListener('wheel', (e) => {
            e.preventDefault();
        });

        const billTemplate = document.getElementById('bill-template');
        const billValues = [1, 2, 5, 10, 20, 50, 100];
        let zIndexCounter = 1;
        let active = null;
        let downX = 0, downY = 0, startLeft = 0, startTop = 0;
        let moved = false;

        billValues.forEach((value, i) => {
            const bill = billTemplate.content.firstElementChild.cloneNode(true);
            bill.dataset.value = value;
            bill.dataset.rot = randomInt(0, 23) * 15;
            bill.querySelector('.denom-topleft').textContent = value;
            bill.querySelector('.denom-topright').textContent = value;
            bill.querySelector('.denom-bottomright').textContent = value;
            bill.querySelector('.denom-bottomleft').textContent = value;
            bill.style.left = `${randomInt(0, 500)}px`;
            bill.style.top = `${randomInt(200, 500)}px`;
            table.appendChild(bill);
        });

        const bills = Array.from(table.querySelectorAll('.bill'));

        bills.forEach((bill) => {
            bill.addEventListener('pointerdown', onPointerDown);
            bill.addEventListener('pointerup', onPointerUp);
            bill.addEventListener('dblclick', onDblClick);
            bill.addEventListener('pointermove', onPointerMove);
            bill.addEventListener('wheel', onWheel);
            updateBillVisual(bill);
        });


        function onPointerDown(e) {
            const bill = e.currentTarget;
            e.preventDefault();
            bill.setPointerCapture(e.pointerId);

            active = bill;
            const rect = bill.getBoundingClientRect();
            const tableRect = table.getBoundingClientRect();

            downX = e.clientX;
            downY = e.clientY;
            startLeft = rect.left - tableRect.left;
            startTop = rect.top - tableRect.top;
            active._offsetX = e.clientX - rect.left;
            active._offsetY = e.clientY - rect.top;
            moved = false;

            bill.style.zIndex = ++zIndexCounter;
            bill.classList.add('dragging');
            updateBillVisual(bill);
        }

        function onPointerUp(e) {
            if (!active) return;
            const bill = active;
            try { bill.releasePointerCapture(e.pointerId); } catch (_) { }
            bill.classList.remove('dragging');

            const billRect = e.currentTarget.getBoundingClientRect();
            if (isBillInDrawer(bill)) {
                bill.dataset.rot = "0";
                updateBillVisual(bill);
                if (isOpen) {
                    const drawerBorders = getDrawerEdges();
                    bill.style.left = `${drawerBorders.left + (drawerBorders.right - drawerBorders.left) / 2 - (220 / 2)}px`;
                    bill.style.top = `${(drawerBorders.bottom - drawerBorders.top) / 2 - (100 / 2)}px`;
                } else {
                    bill.style.top = `${175}px`;
                }
                active = null;
                return;
            }

            updateBillVisual(bill);
            active = null;
        }

        function isBillInDrawer(bill) {
            const billRect = bill.getBoundingClientRect();
            const billCenter = {
                x: billRect.left + billRect.width / 2,
                y: billRect.top + billRect.height / 2
            };
            const drawerBorders = getDrawerEdges();
            return billCenter.x > drawerBorders.left &&
                billCenter.x < drawerBorders.right &&
                billCenter.y < drawerBorders.bottom &&
                billCenter.y > drawerBorders.top
        }

        function onPointerMove(e) {
            if (!active) return;
            const tableRect = table.getBoundingClientRect();
            const bill = active;
            const newLeft = e.clientX - tableRect.left - bill._offsetX;
            const newTop = e.clientY - tableRect.top - bill._offsetY;

            const maxLeft = table.clientWidth - bill.offsetWidth;
            const maxTop = table.clientHeight - bill.offsetHeight;
            bill.style.left = Math.max(0, Math.min(maxLeft, newLeft)) + 'px';
            bill.style.top = Math.max(0, Math.min(maxTop, newTop)) + 'px';
        }

        function onWheel(e) {
            e.preventDefault();
            const bill = e.currentTarget;
            if (isBillInDrawer(bill)) return;
            const rot = parseFloat(bill.dataset.rot || "0");
            const step = (e.deltaY > 0) ? 15 : -15;
            bill.dataset.rot = String(rot + step);
            updateBillVisual(bill);
        }

        function onDblClick(e) {
            const bill = e.currentTarget;
            bill.dataset.flipped = (bill.dataset.flipped === "true") ? "false" : "true";
            updateBillVisual(bill);
        }

        function updateBillVisual(b) {
            const rot = parseFloat(b.dataset.rot || "0");
            const flipped = b.dataset.flipped === "true";
            const scale = b.classList.contains('dragging') ? 1.06 : 1;
            b.style.transform = `rotate(${rot}deg) scale(${scale})`;
            const inner = b.querySelector('.inner');
            if (inner) inner.style.transform = `rotateY(${flipped ? 180 : 0}deg)`;
        }

        const lid = document.querySelector('.lid');
        let isDragging = false;
        let isOpen = false;
        let startY = 0;
        let currentY = 0;

        const maxOpen = 130;

        lid.addEventListener('mousedown', (e) => {
            if (isOpen) {
                lid.style.transform = `translate(-50%, 0px)`;
                isOpen = false;
                return;
            }
            isDragging = true;
            startY = e.clientY;
            currentY = 0;
        });

        document.addEventListener('mousemove', (e) => {
            if (!isDragging) return;
            let delta = e.clientY - startY;
            if (delta < 0) {
                let openAmount = Math.max(delta, -maxOpen);
                lid.style.transform = `translate(-50%, ${openAmount}px)`;
            }
        });

        document.addEventListener('mouseup', () => {
            if (!isDragging) return;
            const matrix = new DOMMatrix(window.getComputedStyle(lid).transform || 'none');
            if ((parseInt(matrix.m42) || 0) < -maxOpen / 2) {
                lid.style.transform = `translate(-50%, ${-maxOpen}px)`;
                isOpen = true;
            } else {
                lid.style.transform = `translate(-50%, 0px)`;
            }
            isDragging = false;
        });

        setupHowToPopup();

        document.addEventListener('contextmenu', function (e) {
            e.preventDefault();
        });
    </script>
</body>
<footer>
    <p>© 2025 <a href="https://www.chrimle.com/">Chrimle</a>. All rights reserved.</p>
</footer>

</html>